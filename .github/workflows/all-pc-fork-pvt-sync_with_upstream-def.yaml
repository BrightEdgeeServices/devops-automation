# all-pc-fork-pvt-sync_with_upstream-def.yaml
name: Merge with Upstream Private Fork

on:
    workflow_call:
        #    inputs:
        #      original_owner:
        #        description: "Set to original owner of the fork."
        #        required:    true
        #        default:     ""
        #        type:        string
        #      original_repo_name:
        #        description: "Set to original repo name of the fork."
        #        required:    true
        #        default:     ""
        #        type:        string
        secrets:
            GH_REPO_ACCESS_BEE_MASTER:
                required: true
            GH_REPO_ACCESS_RTE_MASTER:
                required: true
#      RELEASE_EMAIL_USER:
#        required: true
#      RELEASE_EMAIL_PASSWORD:
#        required: true

jobs:
    Merge:
        runs-on: ${{ matrix.os }}
        env:
            ORIGINAL_OWNER: ${{vars.ORIGINAL_OWNER}}
            ORIGINAL_REPO_NAME: ${{vars.ORIGINAL_REPO_NAME}}

        strategy:
            fail-fast: true
            matrix:
                os: ["ubuntu-latest"]
                python-version: ["3.12"]

        permissions:
            contents: write
            id-token: write

        steps:
            - name: Validate required variables
              run: |
                  if [ -z "$ORIGINAL_OWNER" ] || [ -z "$ORIGINAL_REPO_NAME" ]; then
                      echo "Error: ORIGINAL_OWNER and ORIGINAL_REPO_NAME repository variables must be set."
                      echo "Please configure these variables in your repository settings:"
                      echo "  - Settings > Secrets and variables > Actions > Variables"
                      echo "  - Add variable: ORIGINAL_OWNER (e.g., 'BrightEdgeeServices')"
                      echo "  - Add variable: ORIGINAL_REPO_NAME (e.g., 'devops-automation')"
                      exit 1
                  fi
                  echo "✓ ORIGINAL_OWNER: $ORIGINAL_OWNER"
                  echo "✓ ORIGINAL_REPO_NAME: $ORIGINAL_REPO_NAME"

            - name: Check out repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Set Git identity
              run: |
                  git config --global user.name 'GitHub Action'
                  git config --global user.email 'action@github.com'

            #      - name:              Merge into master
            #        id:                merge
            #        run:               |
            #                           git checkout master
            #                           git merge --no-ff $GITHUB_REF
            #        continue-on-error: false
            #
            #      - name: Push to master
            #        if:   steps.merge.outcome == 'success'
            #        run:  |
            #              git push origin master
            #        env:
            #          GH_TOKEN: ${{ secrets.GH_REPO_ACCESS_CURR_USER }}

            - name: Test upstream repository access
              run: |
                  # Determine which token to use based on the original owner
                  if [ "$ORIGINAL_OWNER" = "BrightEdgeeServices" ]; then
                      UPSTREAM_TOKEN="$GH_REPO_ACCESS_BEE_MASTER"
                      TOKEN_NAME="GH_REPO_ACCESS_BEE_MASTER"
                  else
                      UPSTREAM_TOKEN="$GH_REPO_ACCESS_RTE_MASTER"
                      TOKEN_NAME="GH_REPO_ACCESS_RTE_MASTER"
                  fi

                  echo "Testing access to: https://github.com/$ORIGINAL_OWNER/$ORIGINAL_REPO_NAME"
                  echo "Using token: $TOKEN_NAME"
                  echo "Token length: ${#UPSTREAM_TOKEN} characters"

                  # Test access using GitHub API first
                  echo "Testing via GitHub API..."
                  API_RESPONSE=$(curl -s -w "\n%{http_code}" -H "Authorization: token ${UPSTREAM_TOKEN}" "https://api.github.com/repos/$ORIGINAL_OWNER/$ORIGINAL_REPO_NAME")
                  HTTP_CODE=$(echo "$API_RESPONSE" | tail -n1)

                  if [ "$HTTP_CODE" = "200" ]; then
                      echo "✓ API access successful - token has repository access"
                  else
                      echo "✗ API access failed with HTTP code: $HTTP_CODE"
                      echo "Response: $(echo "$API_RESPONSE" | head -n-1)"
                  fi

                  # Test access using git ls-remote
                  echo ""
                  echo "Testing via git ls-remote..."

                  # Try with x-access-token format first
                  UPSTREAM_URL="https://x-access-token:${UPSTREAM_TOKEN}@github.com/$ORIGINAL_OWNER/$ORIGINAL_REPO_NAME.git"

                  if git ls-remote "$UPSTREAM_URL" >/dev/null 2>&1; then
                      echo "✓ Git access successful with x-access-token format"
                      echo "Available branches and tags:"
                      git ls-remote "$UPSTREAM_URL" | head -10
                  else
                      # Try alternative: token as username (some tokens work better this way)
                      echo "Trying alternative authentication method (token as username)..."
                      UPSTREAM_URL_ALT="https://${UPSTREAM_TOKEN}@github.com/$ORIGINAL_OWNER/$ORIGINAL_REPO_NAME.git"

                      if git ls-remote "$UPSTREAM_URL_ALT" >/dev/null 2>&1; then
                          echo "✓ Git access successful with token as username"
                          echo "Available branches and tags:"
                          git ls-remote "$UPSTREAM_URL_ALT" | head -10
                          UPSTREAM_URL="$UPSTREAM_URL_ALT"
                      else
                          echo "✗ Git access failed with both methods"
                          echo "Attempting with verbose output:"
                          git ls-remote "$UPSTREAM_URL" 2>&1 || true
                          echo ""
                          echo "Note: API access succeeded but git access failed."
                          echo "This may indicate a git-specific authentication issue."
                          echo "The workflow will continue but may fail at the fetch step."
                          # Don't exit - let the fetch step handle the error
                      fi
                  fi

                  # Export the working URL for use in next step
                  echo "UPSTREAM_URL=$UPSTREAM_URL" >> $GITHUB_ENV
              env:
                  GH_REPO_ACCESS_BEE_MASTER: ${{ secrets.GH_REPO_ACCESS_BEE_MASTER }}
                  GH_REPO_ACCESS_RTE_MASTER: ${{ secrets.GH_REPO_ACCESS_RTE_MASTER }}

            - name: Fetch upstream and merge
              run: |
                  # Determine which token to use based on the original owner
                  if [ "$ORIGINAL_OWNER" = "BrightEdgeeServices" ]; then
                      UPSTREAM_TOKEN="$GH_REPO_ACCESS_BEE_MASTER"
                  else
                      UPSTREAM_TOKEN="$GH_REPO_ACCESS_RTE_MASTER"
                  fi

                  # Remove upstream remote if it already exists
                  git remote remove upstream 2>/dev/null || true

                  # Configure git credential helper to store credentials
                  # Format: https://username:password@host
                  # For GitHub, use token as username and token as password, or x-access-token as username
                  git config --global credential.helper store
                  CREDENTIAL_FILE="$HOME/.git-credentials"

                  # Store credentials for github.com with token
                  # Try x-access-token format first
                  echo "https://x-access-token:${UPSTREAM_TOKEN}@github.com" > "$CREDENTIAL_FILE"

                  # Add upstream remote
                  UPSTREAM_REPO_URL="https://github.com/$ORIGINAL_OWNER/$ORIGINAL_REPO_NAME.git"
                  git remote add upstream "$UPSTREAM_REPO_URL"

                  # Try to fetch - if it fails, try alternative credential format
                  if ! git fetch upstream 2>&1; then
                      echo "First attempt failed, trying alternative credential format..."
                      # Try token as username with empty password
                      echo "https://${UPSTREAM_TOKEN}@github.com" > "$CREDENTIAL_FILE"
                      # Remove and re-add remote to clear any cached credentials
                      git remote remove upstream
                      git remote add upstream "$UPSTREAM_REPO_URL"
                      git fetch upstream
                  fi

                  # Checkout master branch
                  git checkout master

                  # Merge upstream/master into master
                  git merge --no-edit upstream/master

                  # Cleanup credentials file
                  rm -f "$CREDENTIAL_FILE"
              env:
                  GH_REPO_ACCESS_BEE_MASTER: ${{ secrets.GH_REPO_ACCESS_BEE_MASTER }}
                  GH_REPO_ACCESS_RTE_MASTER: ${{ secrets.GH_REPO_ACCESS_RTE_MASTER }}

            - name: Push changes
              run: git push origin master

    #      - name: Debug Environment
    #        run: env
