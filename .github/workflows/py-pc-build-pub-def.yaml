# py-pc-build-pub-def.yaml
# Reusable workflow: Create Release and Send Notice after PR merge
name: Build Release And Notify

on:
  workflow_call:
    inputs:
      tag_name:
        description: "Optional: Explicit tag name for the release (e.g., v1.2.3). If omitted, tag is derived from pyproject.toml"
        required: false
        type: string
    secrets:
      PYPI_API_TOKEN_PROD:
        required: true
      RELEASE_EMAIL_USER:
        required: true
      RELEASE_EMAIL_PASSWORD:
        required: true

jobs:
  Build:
    runs-on: ubuntu-latest

    permissions:
      contents: write
    #      id-token: write

    strategy:
      fail-fast: true
      matrix:
        python-version: ["3.13"]

    steps:
      - name: Check out repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0 # Fetch full history to include tags

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}
          architecture: x64

      - name: Install Poetry
        run: |
          curl -sSL https://install.python-poetry.org | python3 -
          echo "PATH=$HOME/.local/bin:$PATH" >> $GITHUB_ENV

      - name: Configure Poetry
        run: |
          poetry config keyring.enabled false

      - name: Install dependencies
        run: |
          poetry install --with dev

      - name: Build and publish with Poetry
        run: |
          poetry build
          poetry publish --username __token__ --password ${{ secrets.PYPI_API_TOKEN_PROD }}
