# py-pc-precom-def.yaml
name: Pre-Commit

on:
  workflow_call:

jobs:
  Pre-Commit:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: true
      matrix:
        os: [ 'ubuntu-latest' ]
        python-version: [ '3.13' ]

    steps:
      - name: Check out code
        uses: actions/checkout@v6

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "npm"

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: ${{ matrix.python-version }}

      - name: Patch Pre-Commit Config for ESLint 9
        run: |
          pip install ruamel.yaml
          python3 -c "import textwrap; exec(textwrap.dedent('''
            import sys, os
            from ruamel.yaml import YAML
            yaml = YAML()
            yaml.preserve_quotes = True
            path = '.pre-commit-config.yaml'
            if os.path.exists(path):
                with open(path, 'r') as f:
                    c = yaml.load(f)
                if c and 'repos' in c:
                    ch = False
                    for r in c['repos']:
                        if 'mirrors-eslint' in r.get('repo', ''):
                            for h in r.get('hooks', []):
                                if h.get('id') == 'eslint':
                                    d = h.get('additional_dependencies', [])
                                    ev = next((x.split('@')[1] for x in d if x.startswith('eslint@')), '9.17.0')
                                    for dep in ['@eslint/js', 'globals']:
                                        if not any(dep in x for x in d):
                                            full_dep = f'{dep}@{ev}' if dep == '@eslint/js' else dep
                                            d.append(full_dep); ch = True
                                    h['additional_dependencies'] = d
                    if ch:
                        with open(path, 'w') as f:
                            yaml.dump(c, f)
                        print('Patched .pre-commit-config.yaml')
            '''))"
          git add .pre-commit-config.yaml || true
        shell: bash

      - name: Install ESLint 9 dependencies at project level
        run: |
          if [ -f eslint.config.js ] || [ -f eslint.config.mjs ] || [ -f eslint.config.cjs ]; then
            npm install --no-save @eslint/js globals --legacy-peer-deps
          fi
        shell: bash

      - name: Run pre-commit checks
        uses: pre-commit/action@v3.0.1
