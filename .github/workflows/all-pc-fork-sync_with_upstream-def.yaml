# all-pc-fork-sync_with_upstream-def.yaml
name: Merge with Upstream Fork

on:
    workflow_call:
        #    inputs:
        #      original_owner:
        #        description: "Set to original owner of the fork."
        #        required:    true
        #        default:     ""
        #        type:        string
        #      original_repo_name:
        #        description: "Set to original repo name of the fork."
        #        required:    true
        #        default:     ""
        #        type:        string
        secrets:
            GH_REPO_ACCESS_BEE_MASTER:
                required: true
            GH_REPO_ACCESS_RTE_MASTER:
                required: true
#      RELEASE_EMAIL_USER:
#        required: true
#      RELEASE_EMAIL_PASSWORD:
#        required: true

jobs:
    Merge:
        runs-on: ${{ matrix.os }}
        env:
            ORIGINAL_OWNER: ${{vars.ORIGINAL_OWNER}}
            ORIGINAL_REPO_NAME: ${{vars.ORIGINAL_REPO_NAME}}

        strategy:
            fail-fast: true
            matrix:
                os: ["ubuntu-latest"]
                python-version: ["3.12"]

        permissions:
            contents: write
            id-token: write

        steps:
            - name: Validate required variables
              run: |
                  if [ -z "$ORIGINAL_OWNER" ] || [ -z "$ORIGINAL_REPO_NAME" ]; then
                      echo "Error: ORIGINAL_OWNER and ORIGINAL_REPO_NAME repository variables must be set."
                      echo "Please configure these variables in your repository settings:"
                      echo "  - Settings > Secrets and variables > Actions > Variables"
                      echo "  - Add variable: ORIGINAL_OWNER (e.g., 'BrightEdgeeServices')"
                      echo "  - Add variable: ORIGINAL_REPO_NAME (e.g., 'devops-automation')"
                      exit 1
                  fi
                  echo "✓ ORIGINAL_OWNER: $ORIGINAL_OWNER"
                  echo "✓ ORIGINAL_REPO_NAME: $ORIGINAL_REPO_NAME"

            - name: Check out repository
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: Set Git identity
              run: |
                  git config --global user.name 'GitHub Action'
                  git config --global user.email 'action@github.com'

            #      - name:              Merge into master
            #        id:                merge
            #        run:               |
            #                           git checkout master
            #                           git merge --no-ff $GITHUB_REF
            #        continue-on-error: false
            #
            #      - name: Push to master
            #        if:   steps.merge.outcome == 'success'
            #        run:  |
            #              git push origin master
            #        env:
            #          GH_TOKEN: ${{ secrets.GH_REPO_ACCESS_CURR_USER }}

            - name: Fetch upstream and merge
              run: |
                  # Determine which token to use based on the original owner
                  if [ "$ORIGINAL_OWNER" = "BrightEdgeeServices" ]; then
                      UPSTREAM_TOKEN="$GH_REPO_ACCESS_BEE_MASTER"
                  else
                      UPSTREAM_TOKEN="$GH_REPO_ACCESS_RTE_MASTER"
                  fi

                  # Remove upstream remote if it already exists
                  git remote remove upstream 2>/dev/null || true

                  # Add upstream remote with authentication token
                  UPSTREAM_URL="https://x-access-token:${UPSTREAM_TOKEN}@github.com/$ORIGINAL_OWNER/$ORIGINAL_REPO_NAME.git"
                  git remote add upstream "$UPSTREAM_URL"

                  # Fetch from upstream
                  git fetch upstream

                  # Checkout master branch
                  git checkout master

                  # Merge upstream/master into master
                  git merge --no-edit upstream/master
              env:
                  GH_REPO_ACCESS_BEE_MASTER: ${{ secrets.GH_REPO_ACCESS_BEE_MASTER }}
                  GH_REPO_ACCESS_RTE_MASTER: ${{ secrets.GH_REPO_ACCESS_RTE_MASTER }}

            - name: Push changes
              run: git push origin master

    #      - name: Debug Environment
    #        run: env
