# all-pc-fork-pub-sync_with_upstream-def.yaml
name: all-pc-fork-pub-sync_with_upstream-def

on:
    workflow_call:
        secrets:
            ORIGINAL_OWNER:
                required: true
            ORIGINAL_REPO_NAME:
                required: true
#      RELEASE_EMAIL_USER:
#        required: true
#      RELEASE_EMAIL_PASSWORD:
#        required: true

jobs:
    Merge:
        runs-on: ${{ matrix.os }}
        env:
            ORIGINAL_OWNER: ${{vars.ORIGINAL_OWNER}}
            ORIGINAL_REPO_NAME: ${{vars.ORIGINAL_REPO_NAME}}

        strategy:
            fail-fast: true
            matrix:
                os: ["ubuntu-latest"]
                python-version: ["3.12"]

        permissions:
            contents: write
            id-token: write

        steps:
            - name: Validate required variables
              run: |
                  if [ -z "$ORIGINAL_OWNER" ] || [ -z "$ORIGINAL_REPO_NAME" ]; then
                      echo "Error: ORIGINAL_OWNER and ORIGINAL_REPO_NAME repository variables must be set."
                      echo "Please configure these variables in your repository settings:"
                      echo "  - Settings > Secrets and variables > Actions > Variables"
                      echo "  - Add variable: ORIGINAL_OWNER (e.g., 'BrightEdgeeServices')"
                      echo "  - Add variable: ORIGINAL_REPO_NAME (e.g., 'devops-automation')"
                      exit 1
                  fi
                  echo "✓ ORIGINAL_OWNER: $ORIGINAL_OWNER"
                  echo "✓ ORIGINAL_REPO_NAME: $ORIGINAL_REPO_NAME"

            - name: Check out repository
              uses: actions/checkout@v6
              with:
                  fetch-depth: 0

            - name: Set Git identity
              run: |
                  git config --global user.name 'GitHub Action'
                  git config --global user.email 'action@github.com'

            - name: Test upstream repository access
              run: |
                  echo "Testing access to public repository: https://github.com/$ORIGINAL_OWNER/$ORIGINAL_REPO_NAME"

                  # Test access using git ls-remote (public repos don't need authentication)
                  UPSTREAM_URL="https://github.com/$ORIGINAL_OWNER/$ORIGINAL_REPO_NAME.git"

                  if git ls-remote "$UPSTREAM_URL" >/dev/null 2>&1; then
                      echo "✓ Git access successful"
                      echo "Available branches and tags:"
                      git ls-remote "$UPSTREAM_URL" | head -10
                  else
                      echo "✗ Git access failed"
                      echo "Attempting with verbose output:"
                      git ls-remote "$UPSTREAM_URL" 2>&1 || true
                      echo "Please verify that the repository is public and accessible."
                      exit 1
                  fi

                  # Export the URL for use in next step
                  echo "UPSTREAM_URL=$UPSTREAM_URL" >> $GITHUB_ENV

            - name: Fetch upstream and merge
              run: |
                  # Remove upstream remote if it already exists
                  git remote remove upstream 2>/dev/null || true

                  # Add upstream remote (public repo, no authentication needed)
                  UPSTREAM_REPO_URL="https://github.com/$ORIGINAL_OWNER/$ORIGINAL_REPO_NAME.git"
                  git remote add upstream "$UPSTREAM_REPO_URL"

                  # Fetch from upstream
                  git fetch upstream

                  # Checkout master branch
                  git checkout master

                  # Merge upstream/master into master
                  git merge --no-edit upstream/master

            - name: Push changes
              run: git push origin master
